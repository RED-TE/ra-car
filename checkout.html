<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>결제하기 | RicarBot</title>
    <!-- Tailwind CSS CDN with plugins -->
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <!-- Google Fonts: Inter & Noto Sans KR -->
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Noto+Sans+KR:wght@400;500;700&amp;display=swap"
        rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        navy: {
                            900: '#0f1729',
                            800: '#1e293b',
                            700: '#334155',
                        },
                        slate: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'Noto Sans KR', 'sans-serif'],
                    },
                    borderRadius: {
                        'custom': '8px',
                    }
                }
            }
        }
    </script>
    <style data-purpose="custom-typography">
        body {
            background-color: #f8fafc;
            color: #0f1729;
            -webkit-font-smoothing: antialiased;
        }

        .font-heading {
            letter-spacing: -0.02em;
        }
    </style>
    <style data-purpose="ui-elements">
        /* Subtle shadows and focus states */
        .card-shadow {
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
        }

        input:focus,
        select:focus {
            border-color: #0f1729 !important;
            ring-color: #0f1729 !important;
            outline: none;
        }

        /* Custom radio/checkbox colors */
        input[type="checkbox"]:checked,
        input[type="radio"]:checked {
            background-color: #0f1729;
            border-color: #0f1729;
        }
    </style>
    <script src="pricing_config.js"></script>
    <script src="common.js"></script>
    <script src="payapp_config.js"></script>
    <script src="https://lite.payapp.kr/public/api/v2/payapp-lite.js"></script>
</head>

<body class="min-h-screen">
    <!-- BEGIN: MainHeader -->
    <header class="bg-white border-b border-slate-200 py-4" data-purpose="global-header">
        <div class="max-w-6xl mx-auto px-4 flex justify-between items-center">
            <div class="flex items-center gap-2 cursor-pointer" onclick="location.href='index.html'">
                <!-- Logo Placeholder -->
                <div class="w-8 h-8 bg-navy-900 rounded flex items-center justify-center">
                    <span class="material-symbols-outlined text-white text-sm">smart_toy</span>
                </div>
                <span class="text-xl font-bold text-navy-900 tracking-tight">RicarBot</span>
            </div>
            <div class="text-slate-500 text-sm flex items-center gap-2">
                <svg class="h-4 w-4" fill="none" stroke="currentColor" viewbox="0 0 24 24"
                    xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"
                        stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                </svg>
                안전한 결제 환경
            </div>
        </div>
    </header>
    <!-- END: MainHeader -->
    <main class="max-w-6xl mx-auto px-4 py-8 md:py-12">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
            <!-- BEGIN: LeftColumn (Checkout Form) -->
            <div class="lg:col-span-8 space-y-8">
                <!-- BEGIN: Plan Selection Section -->
                <section class="bg-white p-6 md:p-8 rounded-custom border border-slate-200 card-shadow"
                    id="plan-selection">
                    <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4 mb-6">
                        <h2 class="text-xl font-bold text-navy-900">플랜 선택</h2>
                        <!-- Plan Toggle Buttons -->
                        <div class="inline-flex p-1 bg-slate-100 rounded-lg">
                            <button
                                class="px-4 py-1.5 text-sm font-medium rounded-md bg-white text-navy-900 shadow-sm border border-slate-200 transition-all"
                                id="toggle-recurring" onclick="setRecurring(true)">정기 결제</button>
                            <button
                                class="px-4 py-1.5 text-sm font-medium text-slate-500 hover:text-navy-900 transition-all"
                                id="toggle-single" onclick="setRecurring(false)">1회 결제</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="plan-container">
                        <!-- Plans injected by JS -->
                    </div>
                </section>
                <!-- END: Plan Selection Section -->
                <!-- BEGIN: Purchaser Info Section -->
                <section class="bg-white p-6 md:p-8 rounded-custom border border-slate-200 card-shadow"
                    id="purchaser-info">
                    <h2 class="text-xl font-bold text-navy-900 mb-6">구매자 정보</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-slate-700" for="user-name">이름</label>
                            <input class="w-full border-slate-200 rounded-custom py-2.5 text-sm" id="user-name"
                                placeholder="성함을 입력해주세요" type="text" />
                        </div>
                        <div class="space-y-2">
                            <label class="block text-sm font-semibold text-slate-700" for="user-email">이메일</label>
                            <input
                                class="w-full border-slate-200 rounded-custom py-2.5 text-sm bg-slate-50 text-slate-400"
                                id="user-email" placeholder="name@company.com" type="email" readonly />
                        </div>
                        <div class="space-y-2 md:col-span-2">
                            <label class="block text-sm font-semibold text-slate-700" for="user-phone">연락처</label>
                            <input class="w-full border-slate-200 rounded-custom py-2.5 text-sm" id="user-phone"
                                placeholder="01000000000 (숫자만 입력)" type="tel" />
                        </div>
                    </div>
                </section>
                <!-- END: Purchaser Info Section -->
                <!-- BEGIN: Legal Consent Section -->
                <section class="bg-white p-6 md:p-8 rounded-custom border border-slate-200 card-shadow"
                    id="legal-consent">
                    <h2 class="text-xl font-bold text-navy-900 mb-6">약관 동의</h2>
                    <div class="space-y-4">
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input class="mt-1 h-4 w-4 text-navy-900 border-slate-300 rounded focus:ring-navy-900"
                                id="check-all" type="checkbox" />
                            <span class="text-sm text-slate-600 leading-relaxed font-bold">
                                모든 결제 및 서비스 이용약관에 동의합니다.
                            </span>
                        </label>
                        <hr class="border-slate-100" />
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input
                                class="consent-check mt-1 h-4 w-4 text-navy-900 border-slate-300 rounded focus:ring-navy-900"
                                id="check-refund" type="checkbox" />
                            <span class="text-sm text-slate-600 leading-relaxed">
                                (필수) 환불정책 및 청약철회 규정에 동의합니다.
                                <a class="text-navy-900 underline underline-offset-4 ml-1" href="license_old.html"
                                    target="_blank">상세보기</a>
                            </span>
                        </label>
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input
                                class="consent-check mt-1 h-4 w-4 text-navy-900 border-slate-300 rounded focus:ring-navy-900"
                                id="check-minor" type="checkbox" />
                            <span class="text-sm text-slate-600 leading-relaxed">
                                (필수) 미성년자 결제 제한 및 이용약관에 동의합니다.
                            </span>
                        </label>
                        <label class="flex items-start gap-3 cursor-pointer group">
                            <input
                                class="consent-check mt-1 h-4 w-4 text-navy-900 border-slate-300 rounded focus:ring-navy-900"
                                id="check-ai-api" type="checkbox" />
                            <span class="text-sm text-orange-600 leading-relaxed font-semibold">
                                (필수) AI API 키 직접 등록 및 키 미발급 시 환불 불가에 동의합니다.
                            </span>
                        </label>
                    </div>
                </section>
                <!-- END: Legal Consent Section -->
            </div>
            <!-- END: LeftColumn -->
            <!-- BEGIN: RightColumn (Order Summary) -->
            <aside class="lg:col-span-4 sticky top-8">
                <div class="bg-white rounded-custom border border-slate-200 card-shadow overflow-hidden">
                    <div class="p-6 bg-slate-50 border-b border-slate-200">
                        <h3 class="text-lg font-bold text-navy-900">주문 요약</h3>
                    </div>
                    <div class="p-6 space-y-4">
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500">선택 플랜</span>
                            <span class="font-semibold text-navy-900" id="summary-name">-</span>
                        </div>
                        <div class="flex justify-between items-center text-sm">
                            <span class="text-slate-500">결제 방식</span>
                            <span class="font-medium text-navy-900" id="summary-type">-</span>
                        </div>
                        <hr class="border-slate-100" />
                        <div class="flex justify-between items-center pt-2">
                            <span class="text-lg font-bold text-navy-900">최종 결제 금액</span>
                            <span class="text-2xl font-bold text-navy-900" id="summary-price">- 원</span>
                        </div>
                    </div>
                    <div class="p-6 pt-0 hidden lg:block">
                        <button
                            class="w-full bg-navy-900 hover:bg-slate-800 text-white font-bold py-4 rounded-custom transition-all flex items-center justify-center gap-2"
                            id="processPayment" onclick="processPayment()">
                            <svg class="h-5 w-5" fill="currentColor" viewbox="0 0 20 20"
                                xmlns="http://www.w3.org/2000/svg">
                                <path clip-rule="evenodd"
                                    d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"
                                    fill-rule_evenodd=""></path>
                            </svg>
                            안전하게 결제하기
                        </button>
                        <div class="mt-4 flex flex-col items-center gap-2">
                            <div class="flex items-center gap-2 text-[11px] text-slate-400">
                                <span class="px-1.5 py-0.5 border border-slate-200 rounded">PG</span>
                                <span>PG사 보안 결제 시스템 적용 중</span>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Trust Signal Below Summary -->
                <div class="mt-6 p-4 rounded-custom border border-slate-200 bg-white flex items-center gap-4">
                    <div class="bg-slate-100 p-2 rounded-full">
                        <svg class="h-6 w-6 text-slate-600" fill="none" stroke="currentColor" viewbox="0 0 24 24"
                            xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z"
                                stroke-linecap="round" stroke-linejoin="round" stroke-width="2"></path>
                        </svg>
                    </div>
                    <div>
                        <p class="text-xs font-bold text-navy-900">결제 보안 보증</p>
                        <p class="text-[11px] text-slate-500">모든 결제 정보는 암호화되어 안전하게 처리됩니다.</p>
                    </div>
                </div>
            </aside>
            <!-- END: RightColumn -->
        </div>
    </main>
    <!-- BEGIN: Mobile Sticky Bottom CTA -->
    <div class="lg:hidden fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 p-4 z-50 card-shadow">
        <div class="max-w-6xl mx-auto flex items-center justify-between gap-4">
            <div>
                <p class="text-[10px] text-slate-500 uppercase font-bold tracking-tighter">최종 결제 금액</p>
                <p class="text-lg font-bold text-navy-900" id="summary-price-mobile">- 원</p>
            </div>
            <button class="flex-1 bg-navy-900 text-white font-bold py-3.5 rounded-custom text-sm"
                onclick="document.getElementById('processPayment').click()">
                결제하기
            </button>
        </div>
    </div>
    <!-- END: Mobile Sticky Bottom CTA -->
    <!-- BEGIN: Footer -->
    <footer class="max-w-6xl mx-auto px-4 py-12 text-slate-400 text-xs border-t border-slate-200 mt-12 pb-24 lg:pb-12">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div>
                <p class="font-bold mb-2 text-slate-500">주식회사 리카오토플랜</p>
                <p>대표자: 조홍철 | 사업자등록번호: 325-60-00844</p>
                <p>경기도 부천시 원미구 신흥로 40, 709호(심곡동, 디오스빌)</p>
            </div>
            <div class="md:text-right">
                <p class="mb-2">고객센터: 1544-0000 (평일 09:00~18:00)</p>
                <p>이메일: jhxox666@naver.com</p>
                <div class="mt-4 flex gap-4 md:justify-end">
                    <a class="hover:text-navy-900 transition-colors" href="license_old.html">이용약관</a>
                    <a class="hover:text-navy-900 transition-colors font-bold"
                        href="privacy_policy_ricarautoplan_multi_pg_nolist.html">개인정보처리방침</a>
                </div>
            </div>
        </div>
    </footer>
    <!-- END: Footer -->

    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="firebase_config.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        let selectedPlanId = urlParams.get('plan') || PRICING_CONFIG.defaultPlan;
        let isRecurring = urlParams.get('recurring') === 'true';

        if (!PRICING_CONFIG.plans[selectedPlanId]) {
            selectedPlanId = PRICING_CONFIG.defaultPlan;
        }

        let currentUser = null;

        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    if (document.getElementById('user-email')) document.getElementById('user-email').value = user.email;
                } else {
                    alert('로그인이 필요합니다.');
                    window.location.href = `login.html?redirect=checkout.html&plan=${selectedPlanId}&recurring=${isRecurring}`;
                }
            });
        }

        const planContainer = document.getElementById('plan-container');

        function renderPlans() {
            planContainer.innerHTML = '';
            Object.values(PRICING_CONFIG.plans).forEach(plan => {
                if (plan.comingSoon) return;
                const activeClass = plan.id === selectedPlanId ? 'border-navy-900 bg-slate-50' : 'border-slate-200 hover:border-slate-300';
                const checked = plan.id === selectedPlanId ? 'checked' : '';

                let priceDisplay = Utils.formatCurrency(plan.price);
                const period = plan.duration === 365 ? '/년' : '/월';

                const html = `
                <label class="relative flex flex-col p-4 border-2 ${activeClass} rounded-custom cursor-pointer transition-all">
                    <input type="radio" name="plan" value="${plan.id}" class="sr-only" ${checked} onchange="updateSelection('${plan.id}')">
                    <div class="flex justify-between items-start mb-2">
                        <span class="font-bold text-lg">${plan.name}</span>
                        ${plan.badge ? `<span class="bg-navy-900 text-white text-[10px] px-2 py-0.5 rounded-full uppercase tracking-wider">${plan.badge}</span>` : ''}
                    </div>
                    <p class="text-slate-500 text-sm mb-4">${plan.desc}</p>
                    <div class="mt-auto">
                        <span class="text-2xl font-bold">${priceDisplay}</span>
                        <span class="text-slate-500 text-sm">${period}</span>
                    </div>
                </label>
                `;
                planContainer.insertAdjacentHTML('beforeend', html);
            });
        }

        window.updateSelection = id => {
            selectedPlanId = id;
            renderPlans();
            updateSummary();
        };

        window.setRecurring = val => {
            isRecurring = val;
            const btnSingle = document.getElementById('toggle-single');
            const btnRecurring = document.getElementById('toggle-recurring');

            if (isRecurring) {
                btnRecurring.className = "px-4 py-1.5 text-sm font-medium rounded-md bg-white text-navy-900 shadow-sm border border-slate-200 transition-all";
                btnSingle.className = "px-4 py-1.5 text-sm font-medium text-slate-500 hover:text-navy-900 transition-all";
            } else {
                btnSingle.className = "px-4 py-1.5 text-sm font-medium rounded-md bg-white text-navy-900 shadow-sm border border-slate-200 transition-all";
                btnRecurring.className = "px-4 py-1.5 text-sm font-medium text-slate-500 hover:text-navy-900 transition-all";
            }
            updateSummary();
        };

        function updateSummary() {
            const plan = PRICING_CONFIG.plans[selectedPlanId];
            document.getElementById('summary-name').textContent = plan.name;
            document.getElementById('summary-price').textContent = Utils.formatCurrency(plan.price) + " 원";
            document.getElementById('summary-price-mobile').textContent = Utils.formatCurrency(plan.price) + " 원";

            const durationText = plan.duration === 365 ? '1년' : '30일';
            document.getElementById('summary-type').textContent = isRecurring ? `${durationText} 정기구독` : `${durationText} 1회결제`;

            // Yearly plans are single-billing only for now
            const subToggleContainer = document.getElementById('toggle-recurring').parentElement;
            if (plan.duration === 365) {
                setRecurring(false);
                subToggleContainer.style.opacity = "0.5";
                subToggleContainer.style.pointerEvents = "none";
            } else {
                subToggleContainer.style.opacity = "1";
                subToggleContainer.style.pointerEvents = "auto";
            }
        }

        const checkAll = document.getElementById('check-all');
        const checkboxes = document.querySelectorAll('.consent-check');
        checkAll.addEventListener('change', e => checkboxes.forEach(cb => cb.checked = e.target.checked));
        checkboxes.forEach(cb => cb.addEventListener('change', () => {
            checkAll.checked = Array.from(checkboxes).every(c => c.checked);
        }));

        window.processPayment = function () {
            try {
                if (!currentUser) return alert('로그인이 필요합니다.');
                const phone = document.getElementById('user-phone').value.trim();
                const name = document.getElementById('user-name').value.trim();
                const plan = PRICING_CONFIG.plans[selectedPlanId];

                const required = ['check-refund', 'check-minor', 'check-ai-api'];
                for (const id of required) { if (!document.getElementById(id).checked) return alert('필수 약관에 동의해주세요.'); }

                if (!name) return alert('성함을 입력해주세요.');
                if (phone.length < 10) return alert('연락처를 정확히 입력해주세요.');

                if (typeof PayApp === 'undefined') throw new Error('결제 모듈 로딩 실패');

                PayApp.setDefault('userid', PAYAPP_CONFIG.userid.trim());
                PayApp.setDefault('shopname', (PAYAPP_CONFIG.shopname || '리카오토플랜').trim());
                PayApp.setParam('goodname', plan.name);
                PayApp.setParam('price', plan.price.toString());
                PayApp.setParam('recvphone', phone);
                PayApp.setParam('memo', name);
                PayApp.setParam('smsuse', 'n');
                PayApp.setParam('var1', currentUser.uid);
                PayApp.setParam('var_email', currentUser.email);

                if (isRecurring) {
                    PayApp.setParam('rebill', 'y');
                    PayApp.setParam('var2', 'subscription');
                }

                PayApp.setParam('redirectpay', '1');
                PayApp.setParam('redirect', 'self');
                PayApp.setParam('skip_screen', 'y');

                const baseReturnUrl = new URL('checkout_success.html', window.location.href).href;
                PayApp.setParam('returnurl', baseReturnUrl);
                if (PAYAPP_CONFIG.feedbackurl) PayApp.setParam('feedbackurl', PAYAPP_CONFIG.feedbackurl.trim());

                PayApp.payrequest();
            } catch (e) { alert(e.message); }
        };

        renderPlans();
        setRecurring(isRecurring);
    </script>
</body>

</html>