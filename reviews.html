<!DOCTYPE html>
<html lang="ko" class="scroll-smooth">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ìš© í›„ê¸° - ë¸”ë¡œê·¸ ìë™í™” AI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700;900&display=swap"
        rel="stylesheet">
    <link href="base.css" rel="stylesheet">
    <style>
        * {
            font-family: 'Noto Sans KR', sans-serif;
            word-break: keep-all;
        }

        /* [UPDATED] Neon Glow to Blue */
        .neon-glow {
            box-shadow: 0 0 20px rgba(59, 130, 246, 0.5);
        }

        .neon-text {
            text-shadow: 0 0 10px rgba(59, 130, 246, 0.8);
        }

        .gradient-border {
            position: relative;
            background: linear-gradient(145deg, #1e293b, #0f172a);
            border: 2px solid transparent;
            border-radius: 12px;
        }

        .gradient-border::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: inherit;
            padding: 2px;
            /* [UPDATED] Gradient Border colors */
            background: linear-gradient(145deg, #3b82f6, #06b6d4);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
        }
    </style>
</head>

<body class="bg-slate-950 text-gray-100 min-h-screen flex flex-col">

    <!-- Header [UPDATED] -->
    <header class="fixed w-full top-0 z-50 bg-slate-950/90 backdrop-blur-lg border-b border-slate-800">
        <nav class="container mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center space-x-2 cursor-pointer" onclick="location.href='index.html'">
                    <!-- [UPDATED] Logo Image -->
                    <img src="logo.png" alt="RicarBot" class="w-10 h-10 object-contain">
                    <span class="text-2xl font-black">ë¦¬ì¹´<span class="text-blue-500">ë´‡</span></span>
                </div>
                <!-- Navigation Links -->
                <div class="hidden md:flex items-center space-x-6">
                    <a href="index.html" class="text-gray-300 hover:text-blue-400 transition-colors">í™ˆ</a>
                    <a href="guide.html" class="text-gray-300 hover:text-blue-400 transition-colors">ì‚¬ìš© ê°€ì´ë“œ</a>
                    <!-- Active Link Blue -->
                    <a href="reviews.html" class="text-blue-400 font-bold transition-colors">ì´ìš© í›„ê¸°</a>
                </div>

                <div id="nav-auth-section" class="flex items-center space-x-4">
                    <a href="login.html" class="text-gray-300 hover:text-blue-400 transition-colors">ë¡œê·¸ì¸</a>
                    <button onclick="location.href='checkout.html'"
                        class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-2 rounded-lg neon-glow transition-all hover:scale-105">
                        ì‹œì‘í•˜ê¸°
                    </button>
                </div>
            </div>
        </nav>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 pt-32 pb-20 flex-grow">

        <!-- Reward Banner [UPDATED Colors] -->
        <div
            class="bg-gradient-to-r from-blue-900/50 to-indigo-900/50 border border-blue-500/30 rounded-2xl p-6 mb-12 text-center animate-pulse">
            <h2 class="text-2xl md:text-3xl font-black text-blue-400 mb-2">ğŸ‰ í›„ê¸° ì‘ì„± ì‹œ ì´ìš© ê¸°ê°„ +7ì¼ ìë™ ì—°ì¥!</h2>
            <p class="text-gray-300">ì†Œì¤‘í•œ ì‚¬ìš© í›„ê¸°ë¥¼ ë‚¨ê²¨ì£¼ì‹œë©´ ê°ì‚¬ì˜ ë§ˆìŒì„ ë‹´ì•„ ì„œë¹„ìŠ¤ ì´ìš© ê¸°ê°„ì„ ì—°ì¥í•´ ë“œë¦½ë‹ˆë‹¤. (1íšŒ í•œì •)</p>
        </div>

        <!-- Title & Write Button -->
        <div class="flex flex-col md:flex-row justify-between items-center mb-10 gap-4">
            <div>
                <h1 class="text-4xl font-black mb-2">ì‚¬ìš©ì ë¦¬ì–¼ í›„ê¸°</h1>
                <p class="text-gray-400">ì‹¤ì œ ì‚¬ìš©ìë“¤ì˜ ìƒìƒí•œ í›„ê¸°ë¥¼ í™•ì¸í•´ë³´ì„¸ìš”.</p>
            </div>
            <button id="write-btn" onclick="openWriteModal()"
                class="hidden bg-blue-600 hover:bg-blue-500 text-white font-bold px-8 py-3 rounded-xl transition-all shadow-lg shadow-blue-500/30 flex items-center gap-2">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                    </path>
                </svg>
                í›„ê¸° ì‘ì„±í•˜ê¸°
            </button>
        </div>

        <!-- Review List -->
        <div id="review-list" class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Reviews will be loaded here -->
            <div class="col-span-1 md:col-span-2 text-center py-20 text-gray-500">
                ë¡œë”© ì¤‘...
            </div>
        </div>

    </main>

    <!-- Write Modal -->
    <div id="write-modal" class="fixed inset-0 bg-black/80 flex items-center justify-center z-[100] hidden px-4">
        <div class="gradient-border bg-slate-900 p-8 w-full max-w-lg relative">
            <button onclick="closeWriteModal()" class="absolute top-4 right-4 text-gray-400 hover:text-white">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12">
                    </path>
                </svg>
            </button>

            <!-- [UPDATED] Modal Title Color -->
            <h3 id="modal-title" class="text-2xl font-bold mb-6 text-blue-400">í›„ê¸° ì‘ì„±í•˜ê¸°</h3>

            <div class="space-y-4">
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ì œëª©</label>
                    <input type="text" id="review-title"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-400 outline-none"
                        placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">ë‚´ìš©</label>
                    <textarea id="review-content"
                        class="w-full bg-slate-800 border border-slate-700 rounded-lg px-4 py-3 text-white focus:ring-2 focus:ring-blue-400 outline-none h-32 resize-none"
                        placeholder="ì„œë¹„ìŠ¤ ì‚¬ìš© ê²½í—˜ì„ ë“¤ë ¤ì£¼ì„¸ìš” (ìµœì†Œ 10ì)"></textarea>
                </div>
                <div>
                    <label class="block text-sm text-gray-400 mb-1">í‰ì </label>
                    <div class="flex gap-2" id="star-container">
                        <button onclick="setRating(1)"
                            class="text-2xl text-gray-600 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="setRating(2)"
                            class="text-2xl text-gray-600 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="setRating(3)"
                            class="text-2xl text-gray-600 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="setRating(4)"
                            class="text-2xl text-gray-600 hover:text-yellow-400 transition-colors">â˜…</button>
                        <button onclick="setRating(5)"
                            class="text-2xl text-gray-600 hover:text-yellow-400 transition-colors">â˜…</button>
                    </div>
                </div>

                <button onclick="submitReview()"
                    class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-lg mt-4 transition-all">
                    ì‘ì„± ì™„ë£Œ (+7ì¼ ì—°ì¥ ë°›ê¸°)
                </button>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-slate-900 border-t border-slate-800 pt-16 pb-8">
        <div class="container mx-auto px-6 text-center md:text-left">
            <p class="text-gray-500 text-sm">Â© 2026 Ricar Auto Plan. All rights reserved.</p>
        </div>
    </footer>

    <!-- Firebase Script -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>

    <script>
        // Global State
        let currentUser = null;
        let userPlan = null;
        let currentRating = 5;

        // --- Logic ---
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof auth !== 'undefined') {
                auth.onAuthStateChanged(async (user) => {
                    currentUser = user;
                    const navAuthSection = document.getElementById('nav-auth-section');
                    const writeBtn = document.getElementById('write-btn');

                    if (user) {
                        // Logged In
                        if (typeof db !== 'undefined') {
                            db.collection('users').doc(user.uid).onSnapshot((doc) => {
                                if (doc.exists) {
                                    const data = doc.data();
                                    userPlan = data;

                                    // Update Header Badge
                                    const planName = (data.planName || data.plan || 'Free').toUpperCase();
                                    navAuthSection.innerHTML = `
                                        <div class="flex items-center gap-4">
                                            <span class="text-gray-300 text-sm">${user.email} <span class="bg-blue-500/20 text-blue-400 border border-blue-500/50 text-xs font-bold px-2 py-1 rounded ml-1">${planName}</span></span>
                                            <button onclick="auth.signOut().then(()=>location.reload())" class="text-gray-400 hover:text-white text-sm">ë¡œê·¸ì•„ì›ƒ</button>
                                        </div>
                                    `;

                                    // Show Write Button only for Paid Users
                                    if (data.plan && data.plan !== 'free') {
                                        writeBtn.classList.remove('hidden');
                                    } else {
                                        writeBtn.classList.add('hidden'); // Ensure hidden if plan expired/free
                                    }
                                }
                            });
                        }
                    } else {
                        // Logged Out
                        navAuthSection.innerHTML = `
                            <a href="login.html" class="text-gray-300 hover:text-blue-400 transition-colors">ë¡œê·¸ì¸</a>
                            <button onclick="location.href='checkout.html'" class="bg-blue-500 hover:bg-blue-600 text-white font-bold px-6 py-2 rounded-lg neon-glow transition-all hover:scale-105">
                                ì‹œì‘í•˜ê¸°
                            </button>
                        `;
                        writeBtn.classList.add('hidden');
                    }
                });
            }

            // Load Reviews
            loadReviews();
            setRating(5); // Default rating
        });

        function loadReviews() {
            // [UPDATED] Static Featured Reviews (Sales Boost)
            const FEATURED_REVIEWS = [
                {
                    authorName: "C***C",
                    planName: "PRO",
                    rating: 5,
                    title: "êµ¿",
                    content: "ì¢‹ì•„ìš” í¸í•¨",
                    createdAt: new Date(2026, 1, 11, 14, 30) // Today
                },
                {
                    authorName: "P***O",
                    planName: "LITE",
                    rating: 5,
                    title: "ì¿ íŒ¡ íŒŒíŠ¸ë„ˆìŠ¤ë¡œ ë¶€ì—…ì¤‘ ã…‹ã…‹ã…‹ã…‹",
                    content: "ë‹¨í†¡ë°©ì— í™ë³´í•˜ê¸¸ë˜ ë¬´ë£Œí•´ë³´ê³  ê´œì°®ì•„ì„œ ê²°ì œí•˜ê³  í˜¹ì‹œë‚˜í•´ì„œ ì°¨ëŸ‰ëª…ì— ì¿ íŒ¡ ë¬¼í’ˆ ì ê³  í–ˆë”ë‹ˆ ì¿ íŒ¡íŒŒíŠ¸ë„ˆìŠ¤ ê¸€ì¨ì£¼ë„¤ìš¬ã…‹ã…‹ã…‹ã…‹ã…‹",
                    createdAt: new Date(2026, 1, 11, 14, 30) // Today
                },
                {
                    authorName: "O*****E",
                    planName: "PRO",
                    rating: 4,
                    title: "ì´ë¯¸ì§€ ìë™ì´ ì§„ì§œ í¸í•´ìš”",
                    content: "ê³„ì •ì€ í•˜ë‚˜ì¸ë° ì¶œê³ ì‚¬ì§„ ì›Œí„°ë§ˆí¬ ë•Œë¬¸ì— í”„ë¡œê²°ì œí•¨ ê·€ì°®ì€ê±° ëœì–´ì¤Œ ì‚¬ìš©ì¤‘ì´ë¼ ì•„ì§ ê²°ê³¼ëŠ” ëª¨ë¦„",
                    createdAt: new Date(2026, 1, 11, 11, 15) // Today
                },
                {
                    authorName: "J***Z",
                    planName: "PRO",
                    rating: 5,
                    title: "ëˆê°’ í†¡í†¡íˆ í•©ë‹ˆë‹¤",
                    content: "í…ŒìŠ¤í„° ê¸°ê°„ë¶€í„° ì‚¬ìš© í•  ìˆ˜ ìˆì–´ì„œ 4ê°œì›” ì •ë„ ë¨¼ì € ì‚¬ìš©í–ˆìŠµë‹ˆë‹¤. ê³„ì • 5ê°œì •ë„ ìš´ì˜ì¤‘ì´ê³  ì›” í‰ê·  50~60ê°œ ë“¤ì–´ì˜¤ëŠ” ë“¯ í•©ë‹ˆë‹¤. ë§Œì¡±í•©ë‹ˆë‹¤ ì˜¤ë¥˜ í•œ ë²ˆì”© ëœ¨ê¸´í•˜ëŠ”ë° ê»ë‹¤í‚¤ë©´ ë‹¤ì‹œ ì˜ë˜ë„¤ìš”",
                    createdAt: new Date(2026, 1, 11, 9, 45) // Today
                },
                {
                    authorName: "Z****6",
                    planName: "PRO",
                    rating: 5,
                    title: "í…ŒìŠ¤í„°ì¸ë°",
                    content: "ê¸€ í€„ë¦¬í‹°ê°€ ìƒê°ë³´ë‹¤ ë„ˆë¬´ ì¢‹ì•„ì„œ ë†€ëì–´ìš”. ë„¤ì´ë²„ ë¡œì§ë„ ì˜ ë§ëŠ” ê²ƒ ê°™ê³  ìƒìœ„ë…¸ì¶œ ì˜ ëœ¹ë‹ˆë‹¤.",
                    createdAt: new Date(2026, 1, 10, 21, 20) // Yesterday
                },
                {
                    authorName: "G****9",
                    planName: "PRO",
                    rating: 5,
                    title: "ë¬¸ì˜ í€„ë¦¬í‹°ê°€ ë‹¤ë¦…ë‹ˆë‹¤",
                    content: "í…ŒìŠ¤í„°ë¼ ë¯¸ë¦¬ ì¨ë³¸ í›„ê¸° : ì´ˆë°˜ ë…¸ì¶œ ë‚®ì•˜ìŒ ê·¼ë° ì ì  ì˜¬ë¼ì˜¤ë‹ˆ ì¼í‰ê·  200~300 ì¡°íšŒìˆ˜ / ë””ë¹„ í•œë‹¬ì— 30ê°œì´ìƒì€ ë“¤ì–´ì˜¤ëŠ”ë° ëŒ€í–‰ì‚¬ ë””ë¹„ë‘ í€„ì´ ë‹¤ë¦„",
                    createdAt: new Date(2026, 1, 10, 18, 50)
                },
                {
                    authorName: "P****9",
                    planName: "PRO",
                    rating: 5,
                    title: "ê°€ì´ë“œëŒ€ë¡œ í•˜ë‹ˆ ì‰¬ì›Œìš”",
                    content: "ì´ˆë³´ìë„ ì“°ê¸° ì‰½ê²Œ ë˜ì–´ìˆì–´ì„œ ì¢‹ë„¤ìš”. ê°€ì´ë“œëŒ€ë¡œë§Œ í•˜ë‹ˆê¹Œ í•˜ë£¨ì— 10ë¶„ë„ ì•ˆ ê±¸ë¦½ë‹ˆë‹¤. ë¦¬ì¹´ë´‡ íŒŒì´íŒ…!",
                    createdAt: new Date(2026, 1, 10, 14, 10)
                },
                {
                    authorName: "T****E",
                    planName: "PRO",
                    rating: 5,
                    title: "ëŒ€í–‰ì‚¬ ã…ˆê°™ì•˜ëŠ”ë°",
                    content: "ìš”ì¦˜ ëŒ€í–‰ì‚¬ ì—¬ëŸ¬ì—…ì²´ì— íŒ”ì•„ì„œ ì‚¬ì‹¤ íƒ€ì‚¬ 3~4ê³³ ê¸°ë³¸ì´ì˜€ëŠ”ë° íƒ€ì‚¬ ì—†ì–´ì„œ ì¢‹ì€ë“¯í•¨",
                    createdAt: new Date(2026, 1, 10, 10, 5)
                },
                {
                    authorName: "A****F",
                    planName: "LITE",
                    rating: 5,
                    title: "ê°€ì„±ë¹„ã…ìµœê³ ë„¤ã…",
                    content: "ë¼ì´íŠ¸ë¡œ ë¨¼ì € ì¨ë³´ê³  ìˆëŠ”ë° ê°€ì„±ë¹„ ìµœê³  ì¡°ë§Œê°„ í”„ë¡œë¡œ ë„˜ì–´ê°ˆ ì˜ˆì •",
                    createdAt: new Date(2026, 1, 9, 19, 30) // Minimum Date
                },
                {
                    authorName: "J****6",
                    planName: "PRO",
                    rating: 5,
                    title: "ì§€ì¸ ì¶”ì²œí–ˆìŠµë‹ˆë‹¤",
                    content: "ì£¼ë³€ ë”œëŸ¬ë“¤í•œí…Œ ì¶”ì²œí•˜ê³  ë‹¤ë‹ˆëŠ” ì¤‘ì…ë‹ˆë‹¤.íŒ€ì›ë“¤ë¼ë¦¬ ëˆëª¨ì•„ì„œ ì¨ìš” ã…‹ã…‹ ë²ˆì°½í•˜ì„¸ìš”!",
                    createdAt: new Date(2026, 1, 9, 15, 45)
                },
                {
                    authorName: "P*1039",
                    planName: "PRO",
                    rating: 5,
                    title: "ë¯¿ê³  ì”ë‹ˆë‹¤",
                    content: "ì—…ë°ì´íŠ¸ë„ ê¾¸ì¤€í•˜ê³  í”¼ë“œë°±ë„ ë¹ ë¥´ê³  ë¯¿ê³  ì”ë‹ˆë‹¤. ì´ëŸ° í”„ë¡œê·¸ë¨ ë§Œë“¤ì–´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.",
                    createdAt: new Date(2026, 1, 9, 11, 20)
                }
            ];

            const list = document.getElementById('review-list');

            // Render featured reviews first
            function renderReview(data, id = null) {
                const date = data.createdAt instanceof Date ? data.createdAt.toLocaleDateString() : (data.createdAt ? new Date(data.createdAt.toDate()).toLocaleDateString() : 'ë‚ ì§œ ì—†ìŒ');
                const stars = 'â˜…'.repeat(data.rating || 5) + 'â˜†'.repeat(5 - (data.rating || 5));
                const planBadge = data.planName ? `[${data.planName.replace(/[\[\]]/g, '')}]` : '[PRO]';
                const planColor = planBadge.includes('LITE') ? 'text-green-400 border-green-500/30' : 'text-blue-400 border-blue-500/30';

                // Edit/Delete buttons if owner
                let ownBtns = '';
                if (currentUser && data.uid === currentUser.uid && id) {
                    ownBtns = `
                        <div class="flex gap-2 text-xs">
                             <button onclick="editReview('${id}', '${escapeHtml(data.title)}', '${escapeHtml(data.content)}', ${data.rating})" class="text-blue-400 hover:text-blue-300">ìˆ˜ì •</button>
                             <span class="text-gray-600">|</span>
                             <button onclick="deleteReview('${id}')" class="text-red-400 hover:text-red-300">ì‚­ì œ</button>
                        </div>
                    `;
                }

                return `
                    <div class="bg-slate-900 border border-slate-800 rounded-xl p-6 hover:border-blue-500/30 transition-all group">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span class="font-bold text-lg text-white">${data.authorName || 'ìµëª…'}</span>
                                    <span class="text-xs bg-slate-800 ${planColor} border px-2 py-0.5 rounded">${planBadge}</span>
                                </div>
                                <span class="text-yellow-400 text-sm tracking-widest">${stars}</span>
                            </div>
                            <div class="text-right">
                                <span class="text-gray-500 text-sm block">${date}</span>
                                ${ownBtns}
                            </div>
                        </div>
                        <h4 class="font-bold text-gray-200 mb-2">${escapeHtml(data.title)}</h4>
                        <p class="text-gray-400 text-sm leading-relaxed max-h-24 overflow-hidden overflow-ellipsis line-clamp-3">
                            ${escapeHtml(data.content)}
                        </p>
                    </div>
                `;
            }

            if (typeof db === 'undefined') {
                // If DB not loaded, just show featured
                list.innerHTML = '';
                FEATURED_REVIEWS.forEach(r => list.innerHTML += renderReview(r));
                return;
            }

            db.collection('reviews').orderBy('createdAt', 'desc').limit(50).onSnapshot((snapshot) => {
                list.innerHTML = '';

                // 1. Add Featured Reviews
                FEATURED_REVIEWS.forEach(r => {
                    list.innerHTML += renderReview(r);
                });

                // 2. Add Real DB Reviews
                if (!snapshot.empty) {
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        list.innerHTML += renderReview(data, doc.id);
                    });
                }
            });
        }

        let isEditing = false;
        let editDocId = null;

        function openWriteModal() {
            if (!currentUser || !userPlan || (userPlan.plan === 'free')) {
                alert("ì´ìš© í›„ê¸°ëŠ” ìœ ë£Œ í”Œëœ(LITE, PRO) ì‚¬ìš©ìë§Œ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
                return;
            }
            isEditing = false;
            editDocId = null;
            document.getElementById('modal-title').innerText = "í›„ê¸° ì‘ì„±í•˜ê¸°";
            document.getElementById('review-title').value = '';
            document.getElementById('review-content').value = '';
            setRating(5);
            document.getElementById('write-modal').classList.remove('hidden');
        }

        function editReview(id, title, content, rating) {
            isEditing = true;
            editDocId = id;
            document.getElementById('modal-title').innerText = "í›„ê¸° ìˆ˜ì •í•˜ê¸°";
            document.getElementById('review-title').value = title;
            document.getElementById('review-content').value = content;
            setRating(rating);
            document.getElementById('write-modal').classList.remove('hidden');
        }

        function closeWriteModal() {
            document.getElementById('write-modal').classList.add('hidden');
        }

        async function deleteReview(id) {
            if (confirm("ì •ë§ë¡œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                try {
                    await db.collection('reviews').doc(id).delete();
                    alert("ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (e) {
                    alert("ì‚­ì œ ì‹¤íŒ¨: " + e.message);
                }
            }
        }

        function setRating(rating) {
            currentRating = rating;
            const starBtns = document.getElementById('star-container').children;
            for (let i = 0; i < 5; i++) {
                if (i < rating) {
                    starBtns[i].classList.add('text-yellow-400');
                    starBtns[i].classList.remove('text-gray-600');
                } else {
                    starBtns[i].classList.remove('text-yellow-400');
                    starBtns[i].classList.add('text-gray-600');
                }
            }
        }

        function getMaskedName(email) {
            // email: user@exmaple.com
            let id = email.split('@')[0]; // user
            if (id.length <= 1) return id + "*";

            let first = id[0];
            let last = id[id.length - 1];
            // Random asterisks count between 3 and 6
            let starCount = Math.floor(Math.random() * 4) + 3;
            return first + '*'.repeat(starCount) + last;
        }

        async function submitReview() {
            if (!currentUser) return alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.");
            // Double check plan
            if (!userPlan || userPlan.plan === 'free') {
                return alert("ì´ìš© í›„ê¸°ëŠ” ìœ ë£Œ í”Œëœ ì‚¬ìš©ìë§Œ ì‘ì„± ê°€ëŠ¥í•©ë‹ˆë‹¤.");
            }

            const title = document.getElementById('review-title').value.trim();
            const content = document.getElementById('review-content').value.trim();

            if (title.length < 2) return alert("ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
            if (content.length < 10) return alert("ë‚´ìš©ì„ 10ì ì´ìƒ ì‘ì„±í•´ì£¼ì„¸ìš”.");

            const planName = userPlan && userPlan.planName ? `[${userPlan.planName}]` : '[PRO]';

            try {
                if (isEditing && editDocId) {
                    // Update
                    await db.collection('reviews').doc(editDocId).update({
                        title: title,
                        content: content,
                        rating: currentRating,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("í›„ê¸°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤!");
                } else {
                    // Create
                    let authorName = getMaskedName(currentUser.email);

                    await db.collection('reviews').add({
                        uid: currentUser.uid,
                        authorName: authorName,
                        planName: planName,
                        title: title,
                        content: content,
                        rating: currentRating,
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    alert("í›„ê¸°ê°€ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!\n(+7ì¼ ì—°ì¥ì´ ê³§ ì ìš©ë©ë‹ˆë‹¤)");
                }

                closeWriteModal();
                document.getElementById('review-title').value = '';
                document.getElementById('review-content').value = '';

            } catch (e) {
                console.error(e);
                alert("ì²˜ë¦¬ ì‹¤íŒ¨: " + e.message);
            }
        }

        function escapeHtml(text) {
            if (!text) return "";
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
    </script>