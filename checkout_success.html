<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ê²°ì œ ì„±ê³µ - ë¦¬ì¹´ì˜¤í† í”Œëœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="base.css" rel="stylesheet">
    <script src="common.js"></script>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
    <div class="card max-w-md w-full text-center relative overflow-hidden">
        <!-- Decoration -->
        <div class="absolute -top-10 -right-10 w-32 h-32 bg-green-500/10 rounded-full blur-3xl"></div>
        <a href="index.html" class="absolute top-4 right-4 text-gray-500 hover:text-white transition-colors z-10">
            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
            </svg>
        </a>

        <div class="w-20 h-20 bg-green-500/20 rounded-full flex items-center justify-center mx-auto mb-6">
            <svg class="w-10 h-10 text-green-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="3" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>

        <h1 class="text-2xl font-black text-white mb-2">ê²°ì œ ì™„ë£Œ!</h1>
        <p class="text-gray-400 mb-8 text-sm">ì£¼ë¬¸ì´ ì„±ê³µì ìœ¼ë¡œ ì²˜ë¦¬ë˜ì—ˆìŠµë‹ˆë‹¤.</p>

        <!-- Summary -->
        <div class="bg-slate-950/50 rounded-xl p-6 mb-8 text-left border border-slate-800 space-y-3 text-sm">
            <div class="flex justify-between"><span class="text-gray-500">ì£¼ë¬¸ë²ˆí˜¸</span> <span class="font-mono text-white"
                    id="oid">...</span></div>
            <div class="flex justify-between"><span class="text-gray-500">ìƒí’ˆëª…</span> <span class="font-bold text-white"
                    id="pname">...</span></div>
            <div class="flex justify-between"><span class="text-gray-500">ê²°ì œê¸ˆì•¡</span> <span
                    class="font-bold text-blue-400" id="amt">...</span></div>
            <div class="flex justify-between"><span class="text-gray-500">ê²°ì œì¼ì‹œ</span> <span class="text-gray-300"
                    id="date">...</span></div>
            <div class="flex justify-between"><span class="text-gray-500">ì´ë©”ì¼</span> <span
                    class="text-gray-300 truncate max-w-[150px]" id="email">...</span></div>
        </div>

        <!-- DB Update Status -->
        <div id="sync-status" class="mb-8 p-4 rounded-xl bg-slate-900 border border-slate-800 text-sm">
            <div class="flex items-center justify-center gap-2 text-gray-400" id="sync-msg">
                <svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                ê³„ì • ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ì¤‘...
            </div>
        </div>

        <div class="space-y-3">
            <button onclick="alert('í”„ë¡œê·¸ë¨ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤. ë¼ì´ì„ ìŠ¤ í‚¤ë¥¼ ë¨¼ì € í™•ì¸í•´ì£¼ì„¸ìš”.')" class="btn-secondary">
                í”„ë¡œê·¸ë¨ ë‹¤ìš´ë¡œë“œ
            </button>
            <button onclick="location.href='license.html'" class="btn-primary">
                ë‚´ êµ¬ë… ì •ë³´ í™•ì¸í•˜ê¸° â†’
            </button>
        </div>

        <p class="mt-6 text-xs text-gray-600">
            * 30ì¼ ì´ìš©ê¶Œ(ë‹¨ê±´) ê²°ì œì…ë‹ˆë‹¤. ì •ê¸°ê²°ì œëŠ” ì ìš©ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
        </p>
    </div>

    <!-- Firebase SDK (Compat Version) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore-compat.js"></script>
    <script src="firebase_config.js"></script>

    <script>
        // Wait for auth state
        if (typeof auth !== 'undefined') {
            auth.onAuthStateChanged(async (user) => {
                const syncMsg = document.getElementById('sync-msg');
                const syncStatus = document.getElementById('sync-status');

                // 1. Try to get order from storage
                let order = Utils.getStorage(STORAGE_KEYS.ORDER);

                // 2. Fallback: Try to parse from URL (PayApp return parameters)
                const urlParams = new URLSearchParams(window.location.search);
                if (!order && urlParams.get('goodname')) {
                    console.log('Order missing in storage, parsing from URL params');
                    order = {
                        orderId: urlParams.get('ordno') || 'unknown',
                        planName: urlParams.get('goodname'),
                        amount: urlParams.get('price'),
                        date: new Date().toISOString(),
                        planId: urlParams.get('goodname').toLowerCase().includes('lite') ? 'lite' : 'pro'
                    };
                }

                if (!order) {
                    console.warn('No order data found');
                    document.querySelector('.bg-slate-950/50').classList.add('hidden');
                    syncMsg.innerHTML = '<span class="text-yellow-500">âš  ê²°ì œ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê²°ì œëŠ” ì™„ë£Œë˜ì—ˆìœ¼ë‚˜ ìë™ ë°˜ì˜ì´ ì•ˆ ë  ê²½ìš° ê³ ê°ì„¼í„°ë¡œ ë¬¸ì˜í•´ì£¼ì„¸ìš”.</span>';
                } else {
                    // Render UI Summary
                    if (document.getElementById('oid')) document.getElementById('oid').textContent = order.orderId;
                    if (document.getElementById('pname')) document.getElementById('pname').textContent = order.planName;
                    if (document.getElementById('amt')) document.getElementById('amt').textContent = Utils.formatCurrency(parseInt(order.amount) || 0);
                    if (document.getElementById('date')) document.getElementById('date').textContent = Utils.formatDate(order.date);
                    if (document.getElementById('email')) document.getElementById('email').textContent = user ? user.email : (order.email || 'ì—°ë™ ì¤‘...');
                }

                if (!user) {
                    if (order) {
                        syncMsg.innerHTML = '<span class="text-blue-400">ğŸ‘‹ ë¡œê·¸ì¸ì„ ëŒ€ê¸°í•˜ê³  ìˆìŠµë‹ˆë‹¤...</span>';
                    }
                    return;
                }

                // Update Database
                try {
                    if (!order) return;

                    syncMsg.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> ë¼ì´ì„ ìŠ¤ í™œì„±í™” ì¤‘...';

                    const now = new Date();
                    const expiry = new Date();
                    expiry.setDate(now.getDate() + 30);

                    const newLicenseKey = Utils.generateLicenseKey();
                    const finalPlan = (order.planId || 'PRO').toLowerCase();
                    const finalPlanName = order.planName || 'PRO Plan';

                    // Use set with merge: true to ensure it works even if doc doesn't exist
                    await db.collection("users").doc(user.uid).set({
                        plan: finalPlan,
                        planName: finalPlanName,
                        paymentDate: now,
                        expiryDate: expiry,
                        licenseKey: newLicenseKey,
                        lastOrderId: order.orderId,
                        updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                    }, { merge: true });

                    console.log("User Upgraded to: " + finalPlan);

                    // Success UI
                    syncStatus.classList.remove('bg-slate-900', 'border-slate-800');
                    syncStatus.classList.add('bg-green-500/20', 'border-green-500/50');
                    syncMsg.innerHTML = '<span class="text-green-400 font-bold">âœ… ë¼ì´ì„ ìŠ¤ê°€ ì„±ê³µì ìœ¼ë¡œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤!</span>';

                    localStorage.removeItem(STORAGE_KEYS.ORDER);

                } catch (e) {
                    console.error("DB Update Failed", e);
                    syncStatus.classList.add('bg-red-500/10', 'border-red-500/30');
                    syncMsg.innerHTML = '<span class="text-red-400">âŒ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨: ' + e.message + '</span>';
                }
            });
        }
    </script>
    <!-- FOOTER -->
    <footer
        class="absolute bottom-0 w-full border-t border-slate-800 bg-slate-900 py-8 text-center text-xs text-gray-500">
        <div class="container-custom space-y-2">
            <p><span class="font-bold text-gray-400">ë¦¬ì¹´ì˜¤í† í”Œëœ</span> | ëŒ€í‘œì: ì¡°í™ì²  | ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸: 325-60-00844</p>
            <p>ì£¼ì†Œ: ê²½ê¸°ë„ ë¶€ì²œì‹œ ì›ë¯¸êµ¬ ì‹ í¥ë¡œ 40, 709í˜¸(ì‹¬ê³¡ë™, ë””ì˜¤ìŠ¤ë¹Œ) </p>
            <p>ê³ ê°ì„¼í„°: <a href="mailto:jhxox666@naver.com" class="text-blue-400 hover:underline">jhxox666@naver.com</a>
            </p>
            <p class="mt-4 copyright">Â© 2026 Ricar Auto Plan. All rights reserved.</p>
        </div>
    </footer>
</body>

</html>